<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<!-- –°–∞–π–¥–±–∞—Ä -->
     <div class="sidebar">
<button class="menu-btn" onclick="menu.hidden^=1">–ú–µ–Ω—é ‚ò∞</button>
<ul class="sidebar" id="menu" hidden>
            <a href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            <a href="/login">–õ–æ–≥–∏–Ω</a>
            <a href="/all_users">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/create_post">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</a>
            <a href="/profile">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>
            <a href="/search">–ü–æ–∏—Å–∫ –¥—Ä—É–∑–µ–π</a>
            <a href="/friends">–ú–æ–∏ –¥—Ä—É–∑—å—è</a>
            <a href="/messages">–°–æ–æ–±—â–µ–Ω–∏—è</a>
            <a href="/logout">–í—ã–π—Ç–∏</a>

</ul>
    </div>

     <div class="container">
        <div class="nav">



        {% for post in posts %}
        <div class="post">
            <h3>{{ post.title }}</h3>
            <p>{{ post.content }}</p>
            <small>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {{ post.date_posted }}</small>

            <div class="post-actions">
                <!-- –õ–∞–π–∫–∏ -->
                <form action="{{ url_for('like_post', post_id=post.id) }}" method="POST"
                      data-action="like" data-post-id="{{ post.id }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                      <button type="submit" class="like-btn">
                           ‚ù§Ô∏è <span class="likes-count">{{ post.likes|length }} –ª–∞–π–∫–æ–≤</span>
                      </button>
                </form>

              <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                <button class="comment-btn" onclick="toggleComments({{ post.id }})">
                    üí¨ {{ post.comments|length }} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                </button>
            </div>

            <!-- –ë–ª–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ - –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç -->
            <div id="comments-{{ post.id }}" class="comments-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</h4>
                    <button class="toggle-comments" onclick="toggleComments({{ post.id }})">–°–∫—Ä—ã—Ç—å</button>
                </div>

                {% for comment in post.comments %}
                <div class="comment">
                    <strong>{{ comment.author.username }}:</strong>
                    <p>{{ comment.text }}</p>
                    <small>{{ comment.date_posted }}</small>
                </div>
                {% endfor %}

                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                <form action="{{ url_for('add_comment', post_id=post.id) }}" method="POST" class="comment-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <textarea name="comment_text" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
                    <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </form>
            </div>
        </div>

{% endfor %}


<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–µ–Ω—é (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª!)
function toggleSidebarMenu() {
    const menu = document.getElementById('menu');
    menu.hidden = !menu.hidden;
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è AJAX-–ª–∞–π–∫–æ–≤
async function likePost(postId, csrfToken) {
    const formData = new FormData();
    formData.append('csrf_token', csrfToken); // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω

    try {
        const response = await fetch(`/like_post/${postId}`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error('Server error');
        }

        const result = await response.json();

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∏ —Å—á–µ—Ç—á–∏–∫
        const likesCount = document.querySelector(`form[data-action="like"][data-post-id="${postId}"] .likes-count`);
        const likeBtn = document.querySelector(`form[data-action="like"][data-post-id="${postId}"] button`);

        likesCount.textContent = result.likes_count + ' –ª–∞–π–∫–æ–≤';

        if (result.liked) {
            likeBtn.style.color = 'red';
        } else {
            likeBtn.style.color = 'gray';
        }
    } catch (error) {
        console.error('Error:', error);
        // –ï—Å–ª–∏ AJAX –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–µ–ª–∞–µ–º –æ–±—ã—á–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
        document.querySelector(`form[data-action="like"][data-post-id="${postId}"]`).submit();
    }
}

// –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ —Ñ–æ—Ä–º—ã –ª–∞–π–∫–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    const likeForms = document.querySelectorAll('form[data-action="like"]');

    likeForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const postId = this.dataset.postId;
            const csrfToken = this.querySelector('input[name="csrf_token"]').value;
            likePost(postId, csrfToken);
        });
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
function toggleComments(postId) {
    const commentsSection = document.getElementById('comments-' + postId);
    if (commentsSection.style.display === 'none') {
        commentsSection.style.display = 'block';
    } else {
        commentsSection.style.display = 'none';
    }
}
</script>

</body>
</html>