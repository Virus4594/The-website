<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Переписка с {{ other_user.username }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
        <div class="container">
        <div class="nav">
            <a href="/">Главная</a>
            <a href="/profile">Профиль</a>
        </div>

        <h2>Переписка с {{ other_user.username }}</h2>

        <div class="chat-container">
            {% for message in message %}
            <div class="message {% if message.sender_id == current_user.id %}my-message{% else %}their-message{% endif %}">
                <strong>{{ message.sender.username }}:</strong>
                <p>{{ message.text }}</p>
                <small>{{ message.date_sent.strftime('%H:%M') }}</small>
            </div>
            {% endfor %}
        </div>

        <form method="POST" action="{{ url_for('message', username=other_user.username) }}" class="message-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <textarea name="message_text" placeholder="Ваше сообщение..." required></textarea>
            <button type="submit" class="btn">Отправить</button>
        </form>

    </div>
<script>
// Функция для отправки сообщения AJAX
async function sendMessage(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);

    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            // Очищаем поле ввода
            form.querySelector('textarea').value = '';
            // Перезагружаем страницу чтобы увидеть новое сообщение
            location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Вешаем обработчик на форму
document.addEventListener('DOMContentLoaded', function() {
    const messageForm = document.querySelector('.message-form');
    messageForm.addEventListener('submit', sendMessage);
});
</script>
</body>
</html>